<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOM Sayfası</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f7fafc;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* Prevent body scroll */
        }
        .sidebar {
            width: 250px;
            background-color: #2d3748; /* Darker sidebar */
            color: white;
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        .sidebar-logo {
            margin-bottom: 2rem;
        }
        .sidebar-logo img {
            max-width: 150px;
            height: auto;
        }
        .sidebar-menu {
            list-style: none;
            padding: 0;
            width: 100%;
            flex-grow: 1;
        }
        .sidebar-menu li {
            margin-bottom: 1.5rem;
        }
        .sidebar-menu a {
            display: flex;
            align-items: center;
            color: #cbd5e0; /* Lighter text for links */
            text-decoration: none;
            font-weight: 500;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background-color: #4a5568; /* Darker on hover/active */
            color: #ffffff;
        }
        .sidebar-menu a svg {
            margin-right: 0.75rem;
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
        .logout-button {
            background-color: #e53e3e; /* Red for logout */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            text-decoration: none;
            font-weight: 600;
            transition: background-color 0.3s ease;
            width: 100%;
            text-align: center;
        }
        .logout-button:hover {
            background-color: #c53030;
        }
        .main-content {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto; /* Allow content to scroll */
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 1rem;
        }
        .header h1 {
            font-size: 2.25rem;
            font-weight: 700;
            color: #2d3748;
        }
        .project-info {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .project-info p {
            font-size: 1rem;
            color: #4a5568;
            margin-bottom: 0.5rem;
        }
        .project-info p strong {
            color: #2d3748;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .section-header h2 {
            font-size: 1.75rem;
            font-weight: 600;
            color: #2d3748;
        }
        .add-button {
            background-color: #48bb78; /* Green for add */
            color: white;
            padding: 0.6rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .add-button:hover {
            background-color: #38a169;
        }
        .material-table {
            width: 100%;
            border-collapse: collapse;
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden; /* Ensures rounded corners apply to content */
        }
        .material-table th, .material-table td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid #edf2f7;
        }
        .material-table th {
            background-color: #ebf4ff; /* Light blue for table header */
            color: #2d3748;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.875rem;
        }
        .material-table tbody tr:last-child td {
            border-bottom: none;
        }
        .material-table tbody tr:hover {
            background-color: #f7fafc;
        }
        .material-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 0.25rem;
        }
        .action-buttons button {
            background-color: #4299e1; /* Blue for edit */
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 0.375rem;
            font-weight: 500;
            margin-right: 0.5rem;
            transition: background-color 0.3s ease;
        }
        .action-buttons button:hover {
            background-color: #3182ce;
        }
        .action-buttons button.delete {
            background-color: #e53e3e; /* Red for delete */
        }
        .action-buttons button.delete:hover {
            background-color: #c53030;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #a0aec0;
        }
        .modal-close-button:hover {
            color: #4a5568;
        }
        .modal h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 1.5rem;
        }
        .modal label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #4a5568;
        }
        .modal input, .modal textarea, .modal select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .modal button[type="submit"] {
            background-color: #48bb78;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .modal button[type="submit"]:hover {
            background-color: #38a169;
        }
        #currentMaterialImagePreview {
            max-width: 100px;
            max-height: 100px;
            margin-top: 10px;
            display: block; /* Show only when image exists */
        }

        /* Material image upload button styling */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            background-color: #4299e1;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-bottom: 1rem;
        }
        .file-input-wrapper:hover {
            background-color: #3182ce;
        }
        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-logo">
            <img src="ASSAN_HANIL-1.png" alt="Hanil Logo">
        </div>
        <ul class="sidebar-menu">
            <li>
                <a href="#" onclick="loadPage('bom_page.html')" class="active">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 3h18a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1zm1 2v14h16V5H4zm2 2h12v2H6V7zm0 4h12v2H6v-2zm0 4h7v2H6v-2z"/>
                    </svg>
                    BOM
                </a>
            </li>
            <li>
                <a href="#" onclick="loadPage('material_stock.html')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M4 4h16a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1zm0 2v12h16V6H4zm2 2h4v4H6V8zm6 0h6v4h-6V8zm-6 6h4v4H6v-4zm6 0h6v4h-6v-4z"/>
                    </svg>
                    Malzeme Stok
                </a>
            </li>
            <li>
                <a href="#" onclick="loadPage('supplier_page.html')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    Tedarikçi
                </a>
            </li>
            <li>
                <a href="#" onclick="loadPage('report_page.html')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M13 2.05v3.03l2.83 2.83-1.41 1.41L13 7.86V11h-2V7.86l-2.42 2.42-1.41-1.41L11 5.08V2.05c-5.06.5-9 4.76-9 9.95s3.94 9.45 9 9.95v-3.03l-2.83-2.83 1.41-1.41L11 16.14V13h2v3.14l2.42-2.42 1.41 1.41L13 18.92v3.03c5.06-.5 9-4.76 9-9.95s-3.94-9.45-9-9.95z"/>
                    </svg>
                    Rapor
                </a>
            </li>
        </ul>
        <a href="#" onclick="logout()" class="logout-button">Çıkış Yap</a>
    </div>

    <div class="main-content">
        <header class="header">
            <h1>BOM Listesi</h1>
            <button onclick="openAddProjectModal()" class="add-button">Yeni Proje Oluştur</button>
        </header>

        <div class="project-info" id="currentProjectInfo">
            </div>

        <section>
            <div class="section-header">
                <h2>Malzemeler</h2>
                <button onclick="openAddMaterialModal()" class="add-button">Malzeme Ekle</button>
            </div>
            <table class="material-table">
                <thead>
                    <tr>
                        <th>Resim</th>
                        <th>Malzeme Kodu</th>
                        <th>Malzeme Adı</th>
                        <th>Miktar</th>
                        <th>Birim</th>
                        <th>Birim Fiyat</th>
                        <th>Toplam Fiyat</th>
                        <th>Açıklama</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody id="materialsTableBody">
                    </tbody>
            </table>
        </section>
    </div>

    <div id="materialModal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeMaterialModal()">×</button>
            <h3 id="materialModalTitle">Yeni Malzeme Ekle</h3>
            <form id="materialForm">
                <input type="hidden" id="materialId">
                <label for="materialImage">Malzeme Resmi:</label>
                <div class="file-input-wrapper">
                    <input type="file" id="materialImage" accept="image/*">
                    Resim Seç
                </div>
                <img id="currentMaterialImagePreview" src="" alt="Malzeme Resmi Önizleme" style="display: none;">

                <label for="materialCode">Malzeme Kodu:</label>
                <input type="text" id="materialCode" required>

                <label for="materialName">Malzeme Adı:</label>
                <input type="text" id="materialName" required>

                <label for="materialQuantity">Miktar:</label>
                <input type="number" id="materialQuantity" required min="1">

                <label for="materialUnit">Birim:</label>
                <input type="text" id="materialUnit" required>

                <label for="materialUnitPrice">Birim Fiyatı:</label>
                <input type="number" id="materialUnitPrice" step="0.01" required min="0">

                <label for="materialDescription">Açıklama:</label>
                <textarea id="materialDescription" rows="3"></textarea>

                <button type="submit">Kaydet</button>
            </form>
        </div>
    </div>

    <script>
        let currentProject = null;
        let projects = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadProjects();
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('projectId');
            if (projectId) {
                currentProject = projects.find(p => p.id == projectId);
            } else if (projects.length > 0) {
                // Eğer URL'de proje ID'si yoksa ve projeler varsa ilk projeyi seç
                currentProject = projects[0];
            }

            if (currentProject) {
                renderProjectInfo();
                renderMaterials();
            } else {
                document.getElementById('currentProjectInfo').innerHTML = '<p class="text-red-500">Gösterilecek bir proje bulunamadı. Lütfen yeni bir proje oluşturun.</p>';
            }
        });

        function loadPage(pageUrl) {
            if (window.parent && window.parent.loadPage) {
                // Eğer BOM sayfasına gidiyorsa ve bir proje seçiliyse, proje ID'sini URL'ye ekle
                if (pageUrl === 'bom_page.html' && currentProject) {
                    window.parent.loadPage(`${pageUrl}?projectId=${currentProject.id}`);
                } else {
                    window.parent.loadPage(pageUrl);
                }
            } else {
                console.error("loadPage function is not available in parent window.");
                window.location.href = pageUrl; // Fallback for direct access
            }
        }

        function logout() {
            // Çıkış yapma mantığı
            if (window.parent && window.parent.loadPage) {
                window.parent.loadPage('login.html');
            } else {
                window.location.href = 'login.html';
            }
        }

        function loadProjects() {
            const storedProjects = localStorage.getItem('projects');
            if (storedProjects) {
                projects = JSON.parse(storedProjects);
            }
        }

        function saveProjects() {
            localStorage.setItem('projects', JSON.stringify(projects));
        }

        function renderProjectInfo() {
            const infoDiv = document.getElementById('currentProjectInfo');
            if (currentProject) {
                infoDiv.innerHTML = `
                    <p><strong>Müşteri Adı:</strong> ${currentProject.customer}</p>
                    <p><strong>Proje Adı:</strong> ${currentProject.name}</p>
                    <p><strong>Başlama Yılı:</strong> ${currentProject.startYear}</p>
                    <p><strong>Proje Ömrü:</strong> ${currentProject.life} Yıl</p>
                    <p><strong>Açıklama:</strong> ${currentProject.description || 'N/A'}</p>
                `;
            } else {
                infoDiv.innerHTML = '<p class="text-red-500">Proje bilgileri yüklenemedi.</p>';
            }
        }

        function renderMaterials() {
            const tableBody = document.getElementById('materialsTableBody');
            tableBody.innerHTML = ''; // Tabloyu temizle

            if (!currentProject || !currentProject.materials || currentProject.materials.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-500">Henüz malzeme eklenmemiş.</td></tr>';
                return;
            }

            currentProject.materials.forEach(material => {
                const row = tableBody.insertRow();
                const totalCost = (material.quantity * material.unitPrice).toFixed(2);
                row.innerHTML = `
                    <td>
                        ${material.image ? `<img src="${material.image}" alt="${material.name}" class="material-image">` : 'Yok'}
                    </td>
                    <td>${material.code}</td>
                    <td>${material.name}</td>
                    <td>${material.quantity}</td>
                    <td>${material.unit}</td>
                    <td>${material.unitPrice.toFixed(2)} TL</td>
                    <td>${totalCost} TL</td>
                    <td>${material.description || 'N/A'}</td>
                    <td class="action-buttons">
                        <button onclick="editMaterial(${material.id})">Düzenle</button>
                        <button class="delete" onclick="deleteMaterial(${material.id})">Sil</button>
                    </td>
                `;
            });
        }

        function openAddProjectModal() {
            // create_project_form.html sayfasına yönlendirme yapar
            loadPage('create_project_form.html');
        }

        let isEditing = false;
        let editingMaterialId = null;

        function openAddMaterialModal() {
            isEditing = false;
            document.getElementById('materialModalTitle').innerText = 'Yeni Malzeme Ekle';
            document.getElementById('materialForm').reset();
            document.getElementById('materialId').value = '';
            document.getElementById('currentMaterialImagePreview').style.display = 'none';
            document.getElementById('currentMaterialImagePreview').src = '';
            document.getElementById('materialModal').classList.remove('hidden');
        }

        function closeMaterialModal() {
            document.getElementById('materialModal').classList.add('hidden');
            isEditing = false;
            editingMaterialId = null;
        }

        document.getElementById('materialImage').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Önizleme resmini göster
                    const preview = document.getElementById('currentMaterialImagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file); // Resmi Base64 olarak oku
            } else {
                document.getElementById('currentMaterialImagePreview').style.display = 'none';
                document.getElementById('currentMaterialImagePreview').src = '';
            }
        });

        document.getElementById('materialForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const id = document.getElementById('materialId').value ? parseInt(document.getElementById('materialId').value) : Date.now();
            const imageFile = document.getElementById('materialImage').files[0];
            const materialCode = document.getElementById('materialCode').value;
            const materialName = document.getElementById('materialName').value;
            const materialQuantity = parseInt(document.getElementById('materialQuantity').value);
            const materialUnit = document.getElementById('materialUnit').value;
            const materialUnitPrice = parseFloat(document.getElementById('materialUnitPrice').value);
            const materialDescription = document.getElementById('materialDescription').value;

            let materialImageBase64 = document.getElementById('currentMaterialImagePreview').src; // Mevcut önizleme resmini al

            if (isEditing && editingMaterialId !== null) {
                // Düzenleme modunda, eğer yeni bir resim seçilmediyse eski resmi koru
                const existingMaterial = currentProject.materials.find(m => m.id === editingMaterialId);
                if (!imageFile && existingMaterial && existingMaterial.image) {
                    materialImageBase64 = existingMaterial.image;
                }
            } else if (!imageFile) {
                 // Yeni eklemede ve resim seçilmediyse boş bırak
                 materialImageBase64 = '';
            }


            // Resim varsa ve Base64 olarak okunmuşsa kullan, yoksa mevcut olanı (veya boş stringi) kullan.
            // Bu kısım FileReader'ın yükleme bitmesini beklemeli. Asenkron işlemi yönetmek için
            // submit olayını bir Promise ile sarmalamak daha iyi olurdu, ama şimdilik hızlı çözüm için
            // resim yüklenene kadar beklemeyi veya mevcut resmi kullanmayı tercih ediyoruz.

            // Async/await kullanarak resim okuma işlemini bekleyelim
            async function processMaterial() {
                if (imageFile) {
                    materialImageBase64 = await readFileAsBase64(imageFile);
                } else if (!isEditing) { // Sadece yeni eklerken ve resim seçilmediyse boş bırak
                    materialImageBase64 = '';
                } else if (isEditing) { // Düzenleme yaparken, resim seçilmediyse mevcut resmi koru
                    const existingMaterial = currentProject.materials.find(m => m.id === editingMaterialId);
                    if (existingMaterial) {
                        materialImageBase64 = existingMaterial.image || '';
                    } else {
                        materialImageBase64 = '';
                    }
                }

                const newMaterial = {
                    id: id,
                    image: materialImageBase64,
                    code: materialCode,
                    name: materialName,
                    quantity: materialQuantity,
                    unit: materialUnit,
                    unitPrice: materialUnitPrice,
                    description: materialDescription
                };

                if (isEditing) {
                    const materialIndex = currentProject.materials.findIndex(m => m.id === editingMaterialId);
                    if (materialIndex !== -1) {
                        currentProject.materials[materialIndex] = newMaterial;
                    }
                } else {
                    currentProject.materials.push(newMaterial);
                }

                saveProjects();
                renderMaterials();
                closeMaterialModal();
            }

            processMaterial();
        });

        // Yardımcı fonksiyon: Dosyayı Base64 olarak okur
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }


        function editMaterial(id) {
            isEditing = true;
            editingMaterialId = id;
            document.getElementById('materialModalTitle').innerText = 'Malzeme Düzenle';

            const material = currentProject.materials.find(m => m.id === id);
            if (material) {
                document.getElementById('materialId').value = material.id;
                document.getElementById('materialCode').value = material.code;
                document.getElementById('materialName').value = material.name;
                document.getElementById('materialQuantity').value = material.quantity;
                document.getElementById('materialUnit').value = material.unit;
                document.getElementById('materialUnitPrice').value = material.unitPrice;
                document.getElementById('materialDescription').value = material.description;

                const preview = document.getElementById('currentMaterialImagePreview');
                if (material.image) {
                    preview.src = material.image;
                    preview.style.display = 'block';
                } else {
                    preview.src = '';
                    preview.style.display = 'none';
                }
                document.getElementById('materialModal').classList.remove('hidden');
            }
        }

        function deleteMaterial(id) {
            if (confirm('Bu malzemeyi silmek istediğinizden emin misiniz?')) {
                currentProject.materials = currentProject.materials.filter(material => material.id !== id);
                saveProjects();
                renderMaterials();
            }
        }
    </script>
</body>
</html>
