<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOM Manager - Bill of Materials</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three/examples/js/controls/OrbitControls.js"></script>
    <style>
        /* Helvetica fontunu ekle */
        body {
            font-family: Helvetica, Arial, sans-serif; /* Helvetica ilk tercih, sonra Arial veya diğer genel sans-serif fontlar */
            background-color: #ffffff; /* Arka plan rengi sabit beyaz yapıldı */
        }
        #modelViewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        #modelCanvas {
            width: 100%;
            height: 100%;
        }
        .close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 28px;
            cursor: pointer;
            z-index: 1001;
        }
        /* Revamped checkbox for Main Product */
        .main-product-checkbox {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 2px solid #4A90E2;
            border-radius: 50%; /* Daire şekli */
            cursor: pointer;
            vertical-align: middle;
            margin-right: 8px;
            transition: all 0.2s ease-in-out;
            position: relative;
        }
        .main-product-checkbox.checked {
            background-color: #22C55E; /* Yeşil arka plan */
            border-color: #22C55E;
        }
        .main-product-checkbox.checked::after {
            content: '✓'; /* Tik işareti */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            font-weight: bold;
            line-height: 1;
        }

        /* Checkbox stillerini güncelledik */
        .checkbox { /* Genel checkbox stilleri */
            display: inline-block;
            width: 28px;
            height: 28px;
            border: 2px solid #4A90E2; /* Varsayılan mavi */
            border-radius: 6px;
            margin-right: 12px;
            cursor: pointer;
            position: relative;
            vertical-align: middle;
        }
        /* BUY filtresi checkbox'ı (Supplier) */
        .checkbox.buy.checked {
            background-color: rgba(255, 204, 203, 0.7); /* Açık Kırmızı (Daha soft ve transparan) */
            border-color: rgba(255, 204, 203, 0.7);
        }
        /* Yeni Raw Material checkbox stili */
        .checkbox.raw-material {
            border-color: #00008B; /* Pers Mavisi */
        }
        .checkbox.raw-material.checked {
            background-color: rgba(0, 0, 139, 0.7); /* Pers Mavisi (Daha soft ve transparan) */
            border-color: rgba(0, 0, 139, 0.7);
        }

        .checkbox.make.checked {
            background-color: rgba(144, 238, 144, 0.7); /* Açık Yeşil (Daha soft ve transparan) */
            border-color: rgba(144, 238, 144, 0.7);
        }

        .table-cell-padding {
            padding: 2px 12px; /* Satır yükseklikleri azaltıldı */
        }
        /* Yeni sınıf: Ana ürün satırları için açık pers mavisi arka plan */
        .bg-main-product-row {
            background-color: rgba(220, 240, 255, 0.7); /* Çok açık mavi tonu (Daha soft ve transparan) */
        }
        /* YENİ EKLENEN CSS: Girintili hücreler için */
        .indent-cell {
            padding-left: var(--indent-level); /* JavaScript tarafından ayarlanacak */
        }

        /* Satır renkleri kaldırıldı */
        /* .bg-supplier-row, .bg-asha-row kaldırıldı */

        /* Başlık ve filtre kutularının arka planı sabit beyaz ve kutulu görünüm kaldırıldı */
        /* Genel konteyner için arka planı ve gölgeleri kaldır */
        .container.mx-auto.bg-white.rounded-lg.shadow-xl.p-8.mb-8 {
            background-color: #ffffff !important; /* Sabit beyaz */
            box-shadow: none !important; /* Gölge kaldırıldı, !important ile çakışmaları önle */
            border-radius: 0 !important; /* Köşe yuvarlaması kaldırıldı, !important ile çakışmaları önle */
            padding: 0 !important; /* İç boşluk kaldırıldı, aşağıdaki div'lere bırakıldı, !important ile çakışmaları önle */
        }

        /* Yeni Malzeme Ekle bölümü için arka planı, kenarlığı ve gölgeyi kaldır */
        .mb-10.p-6.bg-white.rounded-lg.border.border-gray-200 {
            background-color: #ffffff !important; /* Sabit beyaz, !important ile çakışmaları önle */
            border: none !important; /* Kenarlık kaldırıldı, !important ile çakışmaları önle */
            border-radius: 0 !important; /* Köşe yuvarlaması kaldırıldı, !important ile çakışmaları önle */
            padding: 24px; /* Mevcut padding bırakıldı */
            box-shadow: none !important; /* Gölge kaldırıldı, !important ile çakışmaları önle */
        }

        /* Filtreleme ve arama bölümü için arka planı, kenarlığı ve gölgeyi kaldır */
        .flex.flex-col.md\:flex-row.items-center.justify-between.mb-8.p-6.bg-white.rounded-lg.border.border-gray-200 {
            background-color: #ffffff !important; /* Sabit beyaz, !important ile çakışmaları önle */
            border: none !important; /* Kenarlık kaldırıldı, !important ile çakışmaları önle */
            border-radius: 0 !important; /* Köşe yuvarlaması kaldırıldı, !important ile çakışmaları önle */
            padding: 24px; /* Mevcut padding bırakıldı */
            box-shadow: none !important; /* Gölge kaldırıldı, !important ile çakışmaları önle */
        }

        /* Make/Buy yazıları için yeni stiller */
        .text-make {
            color: #22C55E; /* Yeşil */
            font-weight: 300; /* Light Poppins için 300 */
        }
        .text-buy {
            color: #EF4444; /* Kırmızı */
            font-weight: 300; /* Light Poppins için 300 */
        }

        /* Ana ürün satırları için kalın metin */
        .main-product-bold-text td {
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-white p-8 min-h-screen flex flex-col items-center">
    <div class="container mx-auto bg-white rounded-lg shadow-xl p-8 mb-8">
        <h1 class="text-3xl font-extrabold text-left text-gray-800 mb-8">Malzeme Listesi (BOM) Yöneticisi</h1>

        <div class="mb-10 p-6 bg-white rounded-lg border border-gray-200">
            <h2 class="text-xl font-semibold text-gray-700 mb-5">Yeni Malzeme Ekle</h2>
            <form id="materialForm">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div>
                        <label for="libraryInput" class="block text-sm font-medium text-gray-700 mb-1">Kütüphaneden Seç (Arama Yapın)</label>
                        <input list="libraryOptions" id="libraryInput" placeholder="Kütüphanede arayın..." class="border border-gray-300 p-2.5 w-full rounded-md focus:ring-blue-500 focus:border-blue-500" onchange="selectFromLibrary()">
                        <datalist id="libraryOptions">
                            </datalist>
                    </div>
                    <div>
                        <label for="partNumber" class="block text-sm font-medium text-gray-700 mb-1">Parça Numarası</label>
                        <input type="text" id="partNumber" placeholder="Parça Numarası" class="border border-gray-300 p-2.5 w-full rounded-md focus:ring-blue-500 focus:border-500">
                    </div>
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Açıklama</label>
                        <input type="text" id="description" placeholder="Açıklama" class="border border-gray-300 p-2.5 w-full rounded-md focus:ring-blue-500 focus:border-500">
                    </div>
                    <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Miktar</label>
                        <input type="number" id="quantity" placeholder="Miktar" class="border border-gray-300 p-2.5 w-full rounded-md focus:ring-blue-500 focus:border-500">
                    </div>
                    <div>
                        <label for="vendor" class="block text-sm font-medium text-gray-700 mb-1">Tedarikçi</label>
                        <input type="text" id="vendor" placeholder="Tedarikçi" class="border border-gray-300 p-2.5 w-full rounded-md focus:ring-blue-500 focus:border-500">
                    </div>
                    <div>
                        <label for="rawMaterial" class="block text-sm font-medium text-gray-700 mb-1">Hammadde</label>
                        <input type="text" id="rawMaterial" placeholder="Hammadde (Örn: Çelik, Plastik)" class="border border-gray-300 p-2.5 w-full rounded-md focus:ring-blue-500 focus:border-500">
                    </div>
                    <div>
                        <label for="weight" class="block text-sm font-medium text-gray-700 mb-1">Parça Ağırlığı (KG)</label>
                        <input type="number" id="weight" placeholder="Parça Ağırlığı (KG)" class="border border-gray-300 p-2.5 w-full rounded-md focus:ring-blue-500 focus:border-500">
                    </div>
                    <div>
                        <label for="level" class="block text-sm font-medium text-gray-700 mb-1">Seviye (1-4)</label>
                        <input type="number" id="level" placeholder="1 (Otomatik belirlenir, tablodan değiştirilebilir)" class="border border-gray-300 p-2.5 w-full rounded-md focus:ring-blue-500 focus:border-500" min="1" max="4" disabled>
                    </div>
                    <div>
                        <label for="parentPartNumber" class="block text-sm font-medium text-gray-700 mb-1">Ebeveyn Parça Numarası (Opsiyonel)</label>
                        <select id="parentPartNumber" class="border border-gray-300 p-2.5 w-full rounded-md focus:ring-blue-500 focus:border-500">
                            <option value="">Yok (Ana Ürün)</option>
                            </select>
                    </div>
                    <div>
                        <label for="productionLocation" class="block text-sm font-medium text-gray-700 mb-1">Üretim Konumu</label>
                        <select id="productionLocation" class="border border-gray-300 p-2.5 w-full rounded-md focus:ring-blue-500 focus:border-500" required>
                            <option value="" disabled selected>Üretim Konumu Seçin</option>
                            <option value="ASHA">MAKE</option>
                            <option value="Supplier">BUY</option>
                        </select>
                    </div>
                    <div>
                        <label for="productionMethod" class="block text-sm font-medium text-gray-700 mb-1">Üretim Yöntemi</label>
                        <input type="text" id="productionMethod" placeholder="Örn: Enjeksiyon, Döküm" class="border border-gray-300 p-2.5 w-full rounded-md focus:ring-blue-500 focus:border-500">
                    </div>
                    <div>
                        <label for="assemblyType" class="block text-sm font-medium text-gray-700 mb-1">Montaj Şekli</label>
                        <input type="text" id="assemblyType" placeholder="Örn: Cıvatalı, Kaynaklı" class="border border-gray-300 p-2.5 w-full rounded-md focus:ring-blue-500 focus:border-500">
                    </div>
                    <div class="col-span-1 md:col-span-2 lg:col-span-4 grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="photo" class="block text-sm font-medium text-gray-700 mb-1">Fotoğraf:</label>
                            <input type="file" id="photo" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept="image/*">
                        </div>
                        <div>
                            <label for="technicalDrawing" class="block text-sm font-medium text-gray-700 mb-1">Teknik Çizim:</label>
                            <input type="file" id="technicalDrawing" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept=".pdf,image/*">
                        </div>
                        <div>
                            <label for="threeDData" class="block w-full text-sm font-medium text-gray-700 mb-1">3D Verisi:</label>
                            <input type="file" id="threeDData" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept=".stl,.step,.obj,.gltf">
                        </div>
                    </div>
                </div>
                <button type="button" onclick="addMaterial()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">Malzeme Ekle</button>
            </form>
        </div>

        <div class="flex flex-col md:flex-row items-center justify-between mb-8 p-6 bg-white rounded-lg border border-gray-200">
            <div class="flex items-center space-x-6 mb-4 md:mb-0">
                <div class="flex items-center cursor-pointer" onclick="toggleFilter('BUY')">
                    <div class="checkbox buy" id="supplierCheckbox"></div>
                    <span class="text-lg font-medium text-gray-700 select-none">BUY</span>
                </div>
                <div class="flex items-center cursor-pointer" onclick="toggleFilter('MAKE')">
                    <div class="checkbox make" id="ashaCheckbox"></div>
                    <span class="text-lg font-medium text-gray-700 select-none">MAKE</span>
                </div>
                <div class="flex items-center cursor-pointer" onclick="toggleFilter('RAW_MATERIAL')">
                    <div class="checkbox raw-material" id="rawMaterialCheckbox"></div>
                    <span class="text-lg font-medium text-gray-700 select-none">Raw Material</span>
                </div>
            </div>
            <div class="flex items-center w-full md:w-auto">
                <input type="text" id="searchInput" placeholder="Parça No, Açıklama veya Grup Ara..." class="border border-gray-300 p-2.5 rounded-l-md w-full md:w-auto focus:ring-blue-500 focus:border-500">
                <button onclick="searchMaterials()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-r-md transition duration-300 ease-in-out">Ara</button>
            </div>
        </div>

        <div class="overflow-x-auto w-full mb-8">
            <table class="min-w-full bg-white border border-gray-300 rounded-lg shadow-sm" id="bomTable">
                <thead>
                    <tr>
                        <th class="border px-4 py-2 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Ana Ürün</th>
                        <th class="border px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Parça Numarası</th>
                        <th class="border px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Açıklama</th>
                        <th class="border px-4 py-2 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Miktar</th>
                        <th class="border px-4 py-2 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">MAKE/BUY</th>
                        <th class="border px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tedarikçi</th>
                        <th class="border px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Hammadde</th>
                        <th class="border px-4 py-2 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Üretim Yöntemi</th>
                        <th class="border px-4 py-2 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Montaj Şekli</th>
                        <th class="border px-4 py-2 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Seviye</th>
                        <th class="border px-4 py-2 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Ebeveyn Parça No</th>
                        <th class="border px-4 py-2 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Ağırlık (KG)</th>
                        <th class="border px-4 py-2 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Fotoğraf</th>
                        <th class="border px-4 py-2 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Teknik Çizim</th>
                        <th class="border px-4 py-2 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">3D Verisi</th>
                        <th class="border px-4 py-2 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">İşlemler</th>
                    </tr>
                </thead>
                <tbody id="bomTableBody">
                    </tbody>
            </table>
        </div>

        <div id="rawMaterialSummaryContainer" class="hidden w-full mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Hammadde Kullanım Özeti (Yıllık)</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-300 rounded-lg shadow-sm">
                    <thead>
                        <tr>
                            <th class="border px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Hammadde</th>
                            </tr>
                    </thead>
                    <tbody id="rawMaterialSummaryTableBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="modelViewer">
            <span class="close" onclick="closeModelViewer()">&times;</span>
            <canvas id="modelCanvas"></canvas>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/plugins/MultiDrag.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/plugins/Swap.min.js"></script>
    <script>
        // Malzemelerin tutulduğu ana dizi
        let materials = JSON.parse(localStorage.getItem('bomMaterials') || '[]');

        // Volume Tablosu verilerini localStorage'dan al
        const projects = JSON.parse(localStorage.getItem('projects') || '[]');
        const lastProject = projects[projects.length - 1];
        let annualVolumesFromTable = {}; // Ürün adına göre hacimleri tutacak
        let projectStartYear = null;
        let projectLifeYears = 0;

        if (lastProject && lastProject.volumes) {
            lastProject.volumes.forEach(item => {
                annualVolumesFromTable[item.productName] = item.volumes;
            });
            projectStartYear = lastProject.startYear;
            projectLifeYears = lastProject.life;
        }

        // Kütüphane öğeleri (sabit veriler)
        const libraryItems = [
            // Ana Montajlar
            { partNumber: 'ASM-001', description: 'Otomotiv Şasi Montajı', quantity: 1, vendor: 'ASHA', productionLocation: 'ASHA', weight: 350.0, rawMaterial: '', isMainProduct: true, parentPartNumber: null, productionMethod: 'Montaj', assemblyType: 'Cıvatalı', category: 'Ana Montajlar' },
            { partNumber: 'ASM-002', description: 'Uçak Kanat Kiti', quantity: 1, vendor: 'Supplier Y', productionLocation: 'Supplier', weight: 1200.0, rawMaterial: '', isMainProduct: true, parentPartNumber: null, productionMethod: 'İşleme', assemblyType: 'Kaynaklı', category: 'Ana Montajlar' },
            { partNumber: 'ASM-003', description: 'Endüstriyel Robot Kolu', quantity: 1, vendor: 'ASHA', productionLocation: 'ASHA', weight: 80.0, rawMaterial: '', isMainProduct: true, parentPartNumber: null, productionMethod: 'Montaj', assemblyType: 'Lehimli', category: 'Ana Montajlar' },
            { partNumber: 'ASM-004', description: 'Elektronik Kontrol Ünitesi', quantity: 1, vendor: 'ASHA', productionLocation: 'ASHA', weight: 1.5, rawMaterial: '', isMainProduct: true, parentPartNumber: null, productionMethod: 'SMD Montaj', assemblyType: 'Lehimli', category: 'Ana Montajlar' },
            { partNumber: 'ASM-005', description: 'Ev Aletleri Motor Grubu', quantity: 1, vendor: 'Supplier P', productionLocation: 'Supplier', weight: 5.0, rawMaterial: '', isMainProduct: true, parentPartNumber: null, productionMethod: 'Montaj', assemblyType: 'Geçmeli', category: 'Ana Montajlar' },
            
            // Alt Montajlar (Seviye 2)
            { partNumber: 'SUB-001', description: 'Ön Süspansiyon Alt Montajı (ASM-001)', quantity: 1, vendor: 'ASHA', productionLocation: 'ASHA', weight: 30.0, rawMaterial: '', isMainProduct: false, parentPartNumber: 'ASM-001', productionMethod: 'Montaj', assemblyType: 'Geçmeli', category: 'Alt Montajlar' },
            { partNumber: 'SUB-002', description: 'Arka Kanatçık Mekanizması (ASM-002)', quantity: 1, vendor: 'Supplier Z', productionLocation: 'Supplier', weight: 45.0, rawMaterial: '', isMainProduct: false, parentPartNumber: 'ASM-002', productionMethod: 'Büküm', assemblyType: 'Perçinli', category: 'Alt Montajlar' },
            { partNumber: 'SUB-003', description: 'Robot Eklemi Montajı (ASM-003)', quantity: 1, vendor: 'ASHA', productionLocation: 'ASHA', weight: 15.0, rawMaterial: '', isMainProduct: false, parentPartNumber: 'ASM-003', productionMethod: 'Montaj', assemblyType: 'Cıvatalı', category: 'Alt Montajlar' },
            { partNumber: 'SUB-004', description: 'Güç Yönetim Modülü (ASM-004)', quantity: 1, vendor: 'ASHA', productionLocation: 'ASHA', weight: 0.5, rawMaterial: '', isMainProduct: false, parentPartNumber: 'ASM-004', productionMethod: 'SMD Montaj', assemblyType: 'Lehimli', category: 'Alt Montajlar' },
            { partNumber: 'SUB-005', description: 'Fan Muhafazası Montajı (ASM-005)', quantity: 1, vendor: 'ASHA', productionLocation: 'ASHA', weight: 1.2, rawMaterial: '', isMainProduct: false, parentPartNumber: 'ASM-005', productionMethod: 'Montaj', assemblyType: 'Geçmeli', category: 'Alt Montajlar' },

            // Parçalar (Seviye 3 ve 4)
            { partNumber: 'PART-001', description: 'Amortisör Mili (SUB-001)', quantity: 2, vendor: 'Supplier X', productionLocation: 'Supplier', weight: 2.5, rawMaterial: 'Çelik Alaşım', isMainProduct: false, parentPartNumber: 'SUB-001', productionMethod: 'Talaşlı İmalat', assemblyType: 'Cıvatalı', category: 'Parçalar' },
            { partNumber: 'PART-002', description: 'Süspansiyon Burcu (SUB-001)', quantity: 4, vendor: 'ASHA', productionLocation: 'ASHA', weight: 0.1, rawMaterial: 'Poliüretan', isMainProduct: false, parentPartNumber: 'SUB-001', productionMethod: 'Enjeksiyon Kalıplama', assemblyType: 'Geçmeli', category: 'Parçalar' },
            { partNumber: 'PART-003', description: 'Kanatçık Destek Kolu (SUB-002)', quantity: 2, vendor: 'Supplier A', productionLocation: 'Supplier', weight: 5.0, rawMaterial: 'Alüminyum Alaşım', isMainProduct: false, parentPartNumber: 'SUB-002', productionMethod: 'Pres', assemblyType: 'Cıvatalı', category: 'Parçalar' },
            { partNumber: 'PART-004', description: 'Robot Eklemi Dişlisi (SUB-003)', quantity: 1, vendor: 'ASHA', productionLocation: 'ASHA', weight: 0.8, rawMaterial: 'Titanyum', isMainProduct: false, parentPartNumber: 'SUB-003', productionMethod: 'CNC İşleme', assemblyType: 'Geçmeli', category: 'Parçalar' },
            { partNumber: 'PART-005', description: 'Güç Mosfet (SUB-004)', quantity: 8, vendor: 'Supplier B', productionLocation: 'Supplier', weight: 0.005, rawMaterial: 'Silikon', isMainProduct: false, parentPartNumber: 'SUB-004', productionMethod: 'Yarı İletken Üretimi', assemblyType: 'Lehimli', category: 'Elektronik Bileşenler' },
            { partNumber: 'PART-006', description: 'Fan Kanadı (SUB-005)', quantity: 1, vendor: 'ASHA', productionLocation: 'ASHA', weight: 0.3, rawMaterial: 'ABS Plastik', isMainProduct: false, parentPartNumber: 'SUB-005', productionMethod: 'Enjeksiyon Kalıplama', assemblyType: 'Geçmeli', category: 'Parçalar' },

            // Bağımsız Parçalar (Seviye 1)
            { partNumber: 'PART-007', description: 'Bağımsız Sensör Modülü', quantity: 1, vendor: 'Supplier C', productionLocation: 'Supplier', weight: 0.15, rawMaterial: 'PCB, Elektronik Bileşenler', isMainProduct: false, parentPartNumber: null, productionMethod: 'Montaj', assemblyType: 'Lehimli', category: 'Elektronik Bileşenler' },
            { partNumber: 'PART-008', description: 'Hidrolik Valf', quantity: 1, vendor: 'ASHA', productionLocation: 'ASHA', weight: 2.0, rawMaterial: 'Çelik', isMainProduct: false, parentPartNumber: null, productionMethod: 'Talaşlı İmalat', assemblyType: 'Cıvatalı', category: 'Hidrolik Bileşenler' },
            { partNumber: 'PART-009', description: 'Lazer Diyot', quantity: 1, vendor: 'Supplier D', productionLocation: 'Supplier', weight: 0.001, rawMaterial: 'Galyum Arsenit', isMainProduct: false, parentPartNumber: null, productionMethod: 'Yarı İletken Üretimi', assemblyType: 'Lehimli', category: 'Optik Bileşenler' },

            // Diğer Endüstriyel Bileşenler
            { partNumber: 'IND-001', description: 'Yüksek Tork Motoru', quantity: 1, vendor: 'Supplier E', productionLocation: 'Supplier', weight: 25.0, rawMaterial: 'Bakır, Çelik', isMainProduct: false, parentPartNumber: null, productionMethod: 'Montaj', assemblyType: 'Flanşlı', category: 'Motorlar' },
            { partNumber: 'IND-002', description: 'Konveyör Bandı', quantity: 1, vendor: 'ASHA', productionLocation: 'ASHA', weight: 15.0, rawMaterial: 'Kauçuk, Kumaş', isMainProduct: false, parentPartNumber: null, productionMethod: 'Vulkanizasyon', assemblyType: 'Yapıştırma', category: 'Taşıma Sistemleri' },
            { partNumber: 'IND-003', description: 'Basınç Sensörü', quantity: 1, vendor: 'Supplier F', productionLocation: 'Supplier', weight: 0.02, rawMaterial: 'Seramik', isMainProduct: false, parentPartNumber: null, productionMethod: 'Mikrofabrikasyon', assemblyType: 'Lehimli', category: 'Sensörler' },
            { partNumber: 'IND-004', description: 'Endüstriyel Pompa', quantity: 1, vendor: 'ASHA', productionLocation: 'ASHA', weight: 50.0, rawMaterial: 'Dökme Demir, Çelik', isMainProduct: false, parentPartNumber: null, productionMethod: 'Montaj', assemblyType: 'Cıvatalı', category: 'Pompalar' },
            { partNumber: 'IND-005', description: 'Vakum Pompası Contası', quantity: 1, vendor: 'Supplier G', productionLocation: 'Supplier', weight: 0.01, rawMaterial: 'Viton Kauçuk', isMainProduct: false, parentPartNumber: 'IND-004', productionMethod: 'Kalıplama', assemblyType: 'Sıkıştırma', category: 'Contalar ve Sızdırmazlık Elemanları' },

            // Yeni eklenen daha fazla çeşitlilik içeren malzemeler
            { partNumber: 'BAT-001', description: 'Lityum İyon Batarya Paketi', quantity: 1, vendor: 'Supplier H', productionLocation: 'Supplier', weight: 0.7, rawMaterial: 'Lityum, Kobalt, Nikel', isMainProduct: false, parentPartNumber: null, productionMethod: 'Hücre Montajı', assemblyType: 'Kaynaklı', category: 'Enerji Depolama' },
            { partNumber: 'OPT-001', description: 'Optik Lens Grubu', quantity: 1, vendor: 'ASHA', productionLocation: 'ASHA', weight: 0.2, rawMaterial: 'Optik Cam, Alüminyum', isMainProduct: false, parentPartNumber: null, productionMethod: 'Hassas İşleme', assemblyType: 'Yapıştırma', category: 'Optik Bileşenler' },
            { partNumber: 'PCB-001', description: 'Esnek Baskılı Devre Kartı', quantity: 1, vendor: 'Supplier I', productionLocation: 'Supplier', weight: 0.03, rawMaterial: 'Poliimid, Bakır', isMainProduct: false, parentPartNumber: 'ASM-004', productionMethod: 'Baskı', assemblyType: 'Lehimli', category: 'Elektronik Bileşenler' },
            { partNumber: 'STR-001', description: 'Kompozit Yapısal Panel', quantity: 1, vendor: 'ASHA', productionLocation: 'ASHA', weight: 3.0, rawMaterial: 'Karbon Fiber, Epoksi Reçine', isMainProduct: false, parentPartNumber: 'ASM-002', productionMethod: 'Otoklav', assemblyType: 'Yapıştırma', category: 'Yapısal Malzemeler' },
            { partNumber: 'ACT-001', description: 'Lineer Aktüatör', quantity: 1, vendor: 'Supplier J', productionLocation: 'Supplier', weight: 1.5, rawMaterial: 'Çelik, Alüminyum', isMainProduct: false, parentPartNumber: null, productionMethod: 'Montaj', assemblyType: 'Cıvatalı', category: 'Aktüatörler' },
            { partNumber: 'CAB-001', description: 'Fiber Optik Kablo Demeti', quantity: 1, vendor: 'ASHA', productionLocation: 'ASHA', weight: 0.1, rawMaterial: 'Fiber Optik, PVC', isMainProduct: false, parentPartNumber: 'ASM-003', productionMethod: 'Kablo Çekme', assemblyType: 'Sıkıştırma', category: 'Kablolar ve Konnektörler' },
            { partNumber: 'CON-001', description: 'Su Geçirmez Konektör', quantity: 4, vendor: 'Supplier K', productionLocation: 'Supplier', weight: 0.01, rawMaterial: 'PBT, Bakır Alaşım', isMainProduct: false, parentPartNumber: 'PART-007', productionMethod: 'Enjeksiyon', assemblyType: 'Geçmeli', category: 'Kablolar ve Konnektörler' },
            { partNumber: 'FAS-001', description: 'Özel Cıvata Seti', quantity: 10, vendor: 'Supplier L', productionLocation: 'Supplier', weight: 0.05, rawMaterial: 'Paslanmaz Çelik', isMainProduct: false, parentPartNumber: 'PART-001', productionMethod: 'Soğuk Dövme', assemblyType: 'Dişli', category: 'Bağlantı Elemanları' },
            { partNumber: 'FAS-002', description: 'Somun Takımı', quantity: 10, vendor: 'Supplier L', productionLocation: 'Supplier', weight: 0.02, rawMaterial: 'Paslanmaz Çelik', isMainProduct: false, parentPartNumber: 'PART-001', productionMethod: 'Soğuk Dövme', assemblyType: 'Dişli', category: 'Bağlantı Elemanları' },
            { partNumber: 'SEAL-001', description: 'O-ring Sızdırmazlık Elemanı', quantity: 2, vendor: 'ASHA', productionLocation: 'ASHA', weight: 0.002, rawMaterial: 'NBR Kauçuk', isMainProduct: false, parentPartNumber: 'IND-004', productionMethod: 'Kalıplama', assemblyType: 'Sıkıştırma', category: 'Contalar ve Sızdırmazlık Elemanları' },
            { partNumber: 'DISP-001', description: 'LCD Ekran Modülü', quantity: 1, vendor: 'Supplier M', productionLocation: 'Supplier', weight: 0.08, rawMaterial: 'Cam, Silikon', isMainProduct: false, parentPartNumber: 'ASM-003', productionMethod: 'Montaj', assemblyType: 'Soketli', category: 'Ekranlar' },
            { partNumber: 'PNEU-001', description: 'Pnömatik Silindir', quantity: 1, vendor: 'ASHA', productionLocation: 'ASHA', weight: 0.7, rawMaterial: 'Alüminyum, Çelik', isMainProduct: false, parentPartNumber: null, productionMethod: 'Montaj', assemblyType: 'Dişli', category: 'Pnömatik Bileşenler' },
            { partNumber: 'HEAT-001', description: 'Isı Emici', quantity: 1, vendor: 'Supplier N', productionLocation: 'Supplier', weight: 0.05, rawMaterial: 'Alüminyum', isMainProduct: false, parentPartNumber: 'SUB-004', productionMethod: 'Ekstrüzyon', assemblyType: 'Termal Macunlu', category: 'Termal Yönetim' },
            { partNumber: 'SENS-002', description: 'Sıcaklık Sensörü', quantity: 1, vendor: 'Supplier O', productionLocation: 'Supplier', weight: 0.008, rawMaterial: 'Platin', isMainProduct: false, parentPartNumber: 'PART-007', productionMethod: 'SMD Üretimi', assemblyType: 'Lehimli', category: 'Sensörler' },
            { partNumber: 'MTR-001', description: 'Step Motor', quantity: 1, vendor: 'ASHA', productionLocation: 'ASHA', weight: 0.3, rawMaterial: 'Bakır, Çelik', isMainProduct: false, parentPartNumber: 'ASM-003', productionMethod: 'Montaj', assemblyType: 'Cıvatalı', category: 'Motorlar' },
            { partNumber: 'CAP-001', description: 'Elektrolitik Kondansatör', quantity: 20, vendor: 'Supplier P', productionLocation: 'Supplier', weight: 0.003, rawMaterial: 'Alüminyum, Elektrolit', isMainProduct: false, parentPartNumber: 'PCB-001', productionMethod: 'SMD Montaj', assemblyType: 'Lehimli', category: 'Elektronik Bileşenler' },
            { partNumber: 'RES-001', description: 'Metal Film Direnç', quantity: 100, vendor: 'Supplier Q', productionLocation: 'Supplier', weight: 0.0001, rawMaterial: 'Seramik, Metal Film', isMainProduct: false, parentPartNumber: 'PCB-001', productionMethod: 'SMD Montaj', assemblyType: 'Lehimli', category: 'Elektronik Bileşenler' },
            { partNumber: 'LED-001', description: 'SMD LED', quantity: 15, vendor: 'Supplier R', productionLocation: 'Supplier', weight: 0.00005, rawMaterial: 'Galyum Nitrür', isMainProduct: false, parentPartNumber: 'PCB-001', productionMethod: 'SMD Üretimi', assemblyType: 'Lehimli', category: 'Elektronik Bileşenler' },
            { partNumber: 'MCU-001', description: 'Mikrokontrolcü', quantity: 1, vendor: 'Supplier S', productionLocation: 'Supplier', weight: 0.002, rawMaterial: 'Silikon', isMainProduct: false, parentPartNumber: 'PCB-001', productionMethod: 'Yarı İletken Üretimi', assemblyType: 'Lehimli', category: 'Elektronik Bileşenler' },
            { partNumber: 'MEM-001', description: 'Flash Bellek Modülü', quantity: 1, vendor: 'Supplier T', productionLocation: 'Supplier', weight: 0.001, rawMaterial: 'Silikon', isMainProduct: false, parentPartNumber: 'PCB-001', productionMethod: 'Yarı İletken Üretimi', assemblyType: 'Lehimli', category: 'Elektronik Bileşenler' },
            { partNumber: 'CON-002', description: 'USB Tip-C Konnektör', quantity: 1, vendor: 'Supplier U', productionLocation: 'Supplier', weight: 0.004, rawMaterial: 'Bakır Alaşım, Plastik', isMainProduct: false, parentPartNumber: 'PCB-001', productionMethod: 'Montaj', assemblyType: 'Lehimli', category: 'Elektronik Bileşenler' },
            { partNumber: 'DIODE-001', description: 'Zener Diyot', quantity: 50, vendor: 'Supplier V', productionLocation: 'Supplier', weight: 0.0002, rawMaterial: 'Silikon', isMainProduct: false, parentPartNumber: 'PCB-001', productionMethod: 'SMD Üretimi', assemblyType: 'Lehimli', category: 'Elektronik Bileşenler' },
            { partNumber: 'TRANS-001', description: 'NPN Transistör', quantity: 30, vendor: 'Supplier W', productionLocation: 'Supplier', weight: 0.0003, rawMaterial: 'Silikon', isMainProduct: false, parentPartNumber: 'PCB-001', productionMethod: 'SMD Üretimi', assemblyType: 'Lehimli', category: 'Elektronik Bileşenler' },
            { partNumber: 'RELAY-001', description: 'Mini Röle', quantity: 5, vendor: 'Supplier X', productionLocation: 'Supplier', weight: 0.015, rawMaterial: 'Bakır, Plastik', isMainProduct: false, parentPartNumber: 'PCB-001', productionMethod: 'Montaj', assemblyType: 'Lehimli', category: 'Elektronik Bileşenler' },
            { partNumber: 'HEATSHK-001', description: 'Isıyla Daralan Makaron', quantity: 20, vendor: 'ASHA', productionLocation: 'ASHA', weight: 0.001, rawMaterial: 'Poliolefin', isMainProduct: false, parentPartNumber: 'CAB-001', productionMethod: 'Ekstrüzyon', assemblyType: 'Isıtma', category: 'Kablolar ve Konnektörler' },
            { partNumber: 'FAST-004', description: 'Setiskur Vida', quantity: 50, vendor: 'Supplier Y', productionLocation: 'Supplier', weight: 0.005, rawMaterial: 'Karbon Çeliği', isMainProduct: false, parentPartNumber: 'MTR-002', productionMethod: 'Talaşlı İmalat', assemblyType: 'Dişli', category: 'Bağlantı Elemanları' },
            { partNumber: 'SPRING-001', description: 'Sıkıştırma Yayı', quantity: 4, vendor: 'ASHA', productionLocation: 'ASHA', weight: 0.01, rawMaterial: 'Yay Çeliği', isMainProduct: false, parentPartNumber: 'PART-001', productionMethod: 'Tel Bükme', assemblyType: 'Geçmeli', category: 'Yaylar' },
            { partNumber: 'PIPE-001', description: 'Esnek Boru', quantity: 5, vendor: 'Supplier Z', productionLocation: 'Supplier', weight: 0.02, rawMaterial: 'Silikon', isMainProduct: false, parentPartNumber: 'IND-004', productionMethod: 'Ekstrüzyon', assemblyType: 'Sıkıştırma', category: 'Borular ve Hortumlar' }
        ];

        let showSupplier = false;
        let showAsha = false;
        let showRawMaterial = false;

        document.addEventListener('DOMContentLoaded', () => {
            loadMaterials();
            populateLibraryOptions();
            populateParentPartNumberSelect();
            applyFilters(); // Başlangıçta tüm malzemeleri göster
        });

        function populateLibraryOptions() {
            const datalist = document.getElementById('libraryOptions');
            datalist.innerHTML = ''; // Mevcut seçenekleri temizle

            // Kütüphane öğelerini kategoriye göre gruplandır
            const groupedItems = libraryItems.reduce((acc, item) => {
                const category = item.category || 'Diğer'; // Eğer kategori yoksa 'Diğer' olarak gruplandır
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(item);
                return acc;
            }, {});

            // Grupları ve içindeki öğeleri datalist'e ekle
            Object.keys(groupedItems).sort().forEach(category => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = category;
                groupedItems[category].sort((a, b) => a.description.localeCompare(b.description)).forEach(item => {
                    const option = document.createElement('option');
                    option.value = `${item.description} (${item.partNumber})`;
                    option.dataset.partNumber = item.partNumber; // Parça numarasını data attribute olarak sakla
                    optgroup.appendChild(option);
                });
                datalist.appendChild(optgroup);
            });
        }

        function selectFromLibrary() {
            const libraryInput = document.getElementById('libraryInput');
            const selectedOption = document.querySelector(`#libraryOptions option[value='${libraryInput.value}']`);

            if (selectedOption) {
                const partNumber = selectedOption.dataset.partNumber;
                const selectedItem = libraryItems.find(item => item.partNumber === partNumber);

                if (selectedItem) {
                    document.getElementById('partNumber').value = selectedItem.partNumber || '';
                    document.getElementById('description').value = selectedItem.description || '';
                    document.getElementById('quantity').value = selectedItem.quantity || '';
                    document.getElementById('vendor').value = selectedItem.vendor || '';
                    document.getElementById('rawMaterial').value = selectedItem.rawMaterial || ''; // Yeni eklenen kısım
                    document.getElementById('weight').value = selectedItem.weight || '';
                    document.getElementById('productionLocation').value = selectedItem.productionLocation || '';
                    document.getElementById('productionMethod').value = selectedItem.productionMethod || '';
                    document.getElementById('assemblyType').value = selectedItem.assemblyType || '';
                    // Seviye otomatik hesaplanacağı için buradan set etmiyoruz, kullanıcı set edebilir.
                    // document.getElementById('level').value = selectedItem.level || 1; 

                    // Eğer seçilen malzeme ana ürünse, ebeveyn parça numarasını "Yok" yap
                    if (selectedItem.isMainProduct) {
                        document.getElementById('parentPartNumber').value = "";
                    }
                }
            }
        }

        function loadMaterials() {
            const storedMaterials = localStorage.getItem('bomMaterials');
            if (storedMaterials) {
                materials = JSON.parse(storedMaterials);
            }
        }

        function saveMaterials() {
            localStorage.setItem('bomMaterials', JSON.stringify(materials));
        }

        function addMaterial() {
            const partNumber = document.getElementById('partNumber').value;
            const description = document.getElementById('description').value;
            const quantity = document.getElementById('quantity').value;
            const vendor = document.getElementById('vendor').value;
            const rawMaterial = document.getElementById('rawMaterial').value; // Yeni eklenen input
            const weight = document.getElementById('weight').value; // Yeni eklenen input
            const productionLocation = document.getElementById('productionLocation').value;
            const parentPartNumber = document.getElementById('parentPartNumber').value;
            const productionMethod = document.getElementById('productionMethod').value; // Yeni özellik
            const assemblyType = document.getElementById('assemblyType').value; // Yeni özellik
            const photo = document.getElementById('photo').files[0];
            const technicalDrawing = document.getElementById('technicalDrawing').files[0];
            const threeDData = document.getElementById('threeDData').files[0];

            if (!partNumber || !description || !quantity || !productionLocation) {
                alert('Lütfen tüm gerekli alanları doldurun: Parça Numarası, Açıklama, Miktar, Üretim Konumu.');
                return;
            }

            // Benzersiz Parça Numarası kontrolü
            if (materials.some(material => material.partNumber === partNumber)) {
                alert('Bu parça numarası zaten mevcut. Lütfen benzersiz bir parça numarası girin.');
                return;
            }

            // Seviyeyi otomatik olarak ata
            let calculatedLevel;
            if (parentPartNumber === "") {
                calculatedLevel = 1; // Ana ürünse seviye 1
            } else {
                const parentMaterial = materials.find(m => m.partNumber === parentPartNumber);
                calculatedLevel = parentMaterial ? parentMaterial.level + 1 : 1; // Ebeveyn bulunamazsa varsayılan 1
            }

            const newMaterial = {
                partNumber: partNumber || '',
                description: description || '',
                quantity: quantity ? parseInt(quantity) : 0,
                vendor: vendor || '',
                rawMaterial: rawMaterial || '', // Yeni eklenen alan
                weight: weight ? parseFloat(weight) : 0.000, // Yeni eklenen alan
                // level: level ? parseInt(level) : 1, // Eski level ataması
                level: calculatedLevel, // Yeni level ataması
                productionLocation: productionLocation,
                isMainProduct: parentPartNumber === "" ? true : false, // Updated: Automatically set isMainProduct based on parentPartNumber
                productionMethod: productionMethod || '', // Yeni özellik
                assemblyType: assemblyType || '', // Yeni özellik
                photoURL: photo ? URL.createObjectURL(photo) : '',
                technicalDrawingURL: technicalDrawing ? URL.createObjectURL(technicalDrawing) : '',
                threeDDataURL: threeDData ? URL.createObjectURL(threeDData) : '',
                parentPartNumber: parentPartNumber === "" ? null : parentPartNumber
            };

            materials.push(newMaterial);
            localStorage.setItem('bomMaterials', JSON.stringify(materials));
            document.getElementById('materialForm').reset();
            applyFilters(); // Malzeme eklendikten sonra filtreleri yeniden uygula ve tabloyu güncelle
            populateParentPartNumberSelect();
        }

        function displayMaterials(filteredMaterials) {
            const bomTableBody = document.getElementById('bomTableBody');
            bomTableBody.innerHTML = '';
            const rawMaterialSummaryContainer = document.getElementById('rawMaterialSummaryContainer');

            // Eğer showRawMaterial aktifse sadece hammadde özetini göster, aksi takdirde BOM tablosunu göster
            if (showRawMaterial) {
                displayRawMaterialSummary(filteredMaterials);
                rawMaterialSummaryContainer.classList.remove('hidden');
                return;
            } else {
                rawMaterialSummaryContainer.classList.add('hidden'); // Hammadde özeti gizli
            }

            // Ana ürünleri (parentPartNumber'ı null olanlar) bul
            const mainProducts = filteredMaterials.filter(material => material.parentPartNumber === null);

            // Görüntülenecek sıralı malzemeleri tutacak dizi
            let orderedMaterials = [];

            // Ana ürünleri ve alt öğelerini seviyelerine göre sırala
            function sortAndFlatten(items, depth) {
                items.sort((a, b) => a.partNumber.localeCompare(b.partNumber)); // Kendi seviyelerinde Parça Numarasına göre sırala
                items.forEach(item => {
                    orderedMaterials.push({ ...item, depth: depth });
                    const children = filteredMaterials.filter(m => m.parentPartNumber === item.partNumber);
                    if (children.length > 0) {
                        sortAndFlatten(children, depth + 1);
                    }
                });
            }

            // `isDescendant` fonksiyonunu tanımlayın
            function isDescendant(potentialParentPartNumber, currentChildPartNumber) {
                let current = materials.find(m => m.partNumber === currentChildPartNumber);
                while (current && current.parentPartNumber !== null) {
                    if (current.parentPartNumber === potentialParentPartNumber) {
                        return true;
                    }
                    current = materials.find(m => m.partNumber === current.parentPartNumber);
                }
                return false;
            }


            sortAndFlatten(mainProducts, 0); // En üst seviyeden başla

            orderedMaterials.forEach(material => {
                const row = document.createElement('tr');
                // Renk sınıfları kaldırıldı. Ana ürün arka plan rengi ve kalın metin eklendi.
                const mainProductBgClass = material.isMainProduct ? 'bg-main-product-row' : '';
                const mainProductBoldTextClass = material.isMainProduct ? 'main-product-bold-text' : '';
                row.className = `${mainProductBgClass} ${mainProductBoldTextClass}`;
                row.dataset.partNumber = material.partNumber;

                // Girinti miktarını hesapla (1cm = 16px gibi, veya rem kullanabiliriz)
                const indentAmount = material.depth * 16; // Her derinlik seviyesi için 16px (yaklaşık 1rem) girinti

                const productionLocationText = material.productionLocation === 'ASHA' ? `<span class="text-make">MAKE</span>` : `<span class="text-buy">BUY</span>`;

                row.innerHTML = `
                    <td class="border px-4 py-2 table-cell-padding text-center">
                        <div class="main-product-checkbox ${material.isMainProduct ? 'checked' : ''}" onclick="toggleMainProduct('${material.partNumber}', event)"></div>
                    </td>
                    <td class="border px-4 py-2 table-cell-padding indent-cell" style="--indent-level: ${indentAmount}px;">${material.partNumber}</td>
                    <td class="border px-4 py-2 table-cell-padding">${material.description}</td>
                    <td class="border px-4 py-2 text-center table-cell-padding">
                        <input type="number" value="${material.quantity}" onchange="updateQuantity('${material.partNumber}', this.value)" class="w-16 text-center border rounded px-1 py-0.5">
                    </td>
                    <td class="border px-4 py-2 text-center table-cell-padding">${productionLocationText}</td>
                    <td class="border px-4 py-2 table-cell-padding">${material.vendor || '-'}</td>
                    <td class="border px-4 py-2 table-cell-padding">${material.rawMaterial || '-'}</td>
                    <td class="border px-4 py-2 text-center table-cell-padding">${material.productionMethod || '-'}</td>
                    <td class="border px-4 py-2 text-center table-cell-padding">${material.assemblyType || '-'}</td>
                    <td class="border px-4 py-2 text-center table-cell-padding">
                        <input type="number" value="${material.level}" onchange="updateLevel('${material.partNumber}', this.value)" class="w-16 text-center border rounded px-1 py-0.5" min="1" max="4">
                    </td>
                    <td class="border px-4 py-2 text-center table-cell-padding">
                        <select onchange="updateParentPartNumber('${material.partNumber}', this.value)" class="border rounded px-1 py-0.5 text-sm w-32">
                            <option value="" ${material.parentPartNumber === null ? 'selected' : ''}>Yok (Ana Ürün)</option>
                            ${materials.filter(m => m.partNumber !== material.partNumber && !isDescendant(material.partNumber, m.partNumber)).map(m => `
                                <option value="${m.partNumber}" ${material.parentPartNumber === m.partNumber ? 'selected' : ''}>
                                    ${m.partNumber} - ${m.description}
                                </option>
                            `).join('')}
                        </select>
                    </td>
                    <td class="border px-4 py-2 text-center table-cell-padding">
                        <input type="number" step="0.001" value="${material.weight}" onchange="updateWeight('${material.partNumber}', this.value)" class="w-20 text-center border rounded px-1 py-0.5">
                    </td>
                    <td class="border px-4 py-2 text-center table-cell-padding flex justify-center items-center">
                        ${material.photoURL ? `<img src="${material.photoURL}" alt="Photo" class="w-8 h-8 object-cover rounded-md" />` : '-'}
                    </td>
                    <td class="border px-4 py-2 text-center table-cell-padding">
                        ${material.technicalDrawingURL ? `<a href="${material.technicalDrawingURL}" target="_blank" class="text-blue-600 hover:underline">Görüntüle</a>` : '-'}
                    </td>
                    <td class="border px-4 py-2 text-center table-cell-padding">
                        ${material.threeDDataURL ? `<button onclick="openModelViewer('${material.threeDDataURL}')" class="text-blue-600 hover:underline">Görüntüle</button>` : '-'}
                    </td>
                    <td class="border px-4 py-2 text-center table-cell-padding">
                        <button onclick="removeMaterial('${material.partNumber}')" class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded">Sil</button>
                    </td>
                `;
                bomTableBody.appendChild(row);
            });

            // SortableJS'i başlat (eğer zaten başlatılmadıysa)
            if (typeof Sortable !== 'undefined') {
                new Sortable(bomTableBody, {
                    animation: 150,
                    ghostClass: 'blue-background-class',
                    onEnd: function (evt) {
                        const movedItemPartNumber = evt.item.dataset.partNumber;
                        const oldIndex = evt.oldIndex;
                        const newIndex = evt.newIndex;

                        if (oldIndex !== newIndex) {
                            const [movedItem] = orderedMaterials.splice(oldIndex, 1);
                            orderedMaterials.splice(newIndex, 0, movedItem);

                            // `materials` dizisini `orderedMaterials` sırasına göre güncelle
                            const newMaterialsOrder = orderedMaterials.map(item => materials.find(m => m.partNumber === item.partNumber));
                            materials = newMaterialsOrder;
                            saveMaterials();
                            applyFilters(); // Tabloyu yeni sıraya göre yeniden çiz
                        }
                    }
                });
            }
        }

        function displayRawMaterialSummary(filteredMaterials) {
            const rawMaterialSummaryTableBody = document.getElementById('rawMaterialSummaryTableBody');
            rawMaterialSummaryTableBody.innerHTML = ''; // Önceki içeriği temizle

            const rawMaterialSummary = {};

            // Hammadde kullanımını hesapla
            filteredMaterials.forEach(item => {
                if (item.rawMaterial) {
                    if (!rawMaterialSummary[item.rawMaterial]) {
                        rawMaterialSummary[item.rawMaterial] = {
                            totalUsage: 0,
                            yearlyUsage: Array(projectLifeYears).fill(0) // Yıllık kullanımı tutacak dizi
                        };
                    }
                    rawMaterialSummary[item.rawMaterial].totalUsage += item.quantity * item.weight;

                    // Yıllık hacim verileri varsa, yıllık kullanımı hesapla
                    if (annualVolumesFromTable[item.description]) {
                        const volumes = annualVolumesFromTable[item.description];
                        for (let i = 0; i < projectLifeYears; i++) {
                            const usage = (volumes[i] || 0) * item.quantity * item.weight;
                            rawMaterialSummary[item.rawMaterial].yearlyUsage[i] += usage;
                        }
                    }
                }
            });

            // Başlık satırını oluştur
            const tableHead = document.querySelector('#rawMaterialSummaryContainer table thead tr');
            tableHead.innerHTML = '<th class="border px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Hammadde</th>';
            for (let i = 0; i < projectLifeYears; i++) {
                tableHead.innerHTML += `<th class="border px-4 py-2 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">${projectStartYear + i}</th>`;
            }

            // Tabloyi doldur
            for (const rmName in rawMaterialSummary) {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="border px-4 py-2">${rmName}</td>`;
                rawMaterialSummary[rmName].yearlyUsage.forEach(usage => {
                    row.innerHTML += `<td class="border px-4 py-2 text-center">${usage.toFixed(2)} kg</td>`;
                });
                rawMaterialSummaryTableBody.appendChild(row);
            }
        }


        function populateParentPartNumberSelect() {
            const select = document.getElementById('parentPartNumber');
            select.innerHTML = '<option value="">Yok (Ana Ürün)</option>'; // İlk seçenek
            // Sadece seviye 1, 2 veya 3 olan malzemeleri ebeveyn olarak ekle
            materials.filter(m => m.level >= 1 && m.level <= 3).forEach(material => {
                const option = document.createElement('option');
                option.value = material.partNumber;
                option.textContent = `${material.partNumber} - ${material.description}`;
                select.appendChild(option);
            });
        }

        function toggleMainProduct(partNumber, event) {
            event.stopPropagation(); // Olayın satır tıklamasına yayılmasını engelle
            const material = materials.find(m => m.partNumber === partNumber);
            if (material) {
                // Ana ürün olmaktan çıkarılıyorsa, tüm alt öğelerinin ebeveynini null yap
                if (material.isMainProduct && confirm("Bu ürünü ana ürün olmaktan çıkarmak istediğinizden emin misiniz? Altındaki tüm malzemelerin ebeveynleri 'Yok (Ana Ürün)' olarak ayarlanacaktır.")) {
                    material.isMainProduct = false;
                    material.parentPartNumber = null;
                    material.level = 1; // Ana ürün olunca seviye 1'e döner

                    // Alt öğelerin seviyelerini ve ebeveynlerini güncellemek için recursive bir fonksiyon
                    const updateChildren = (parentPn, newLevel) => {
                        materials.forEach(m => {
                            if (m.parentPartNumber === parentPn) {
                                m.parentPartNumber = null; // Ebeveynini kaldır
                                m.level = newLevel; // Yeni seviye ata (artık ana ürün oldukları için 1)
                                m.isMainProduct = true; // Artık kendileri ana ürün
                                updateChildren(m.partNumber, newLevel + 1); // Alt öğeleri güncelle
                            }
                        });
                    };
                    updateChildren(partNumber, 1); // Başlangıç seviyesi 1
                } else if (!material.isMainProduct) {
                    // Ana ürün yapılıyorsa, mevcut ebeveynini kaldır
                    material.isMainProduct = true;
                    material.parentPartNumber = null;
                    material.level = 1;
                }
                saveMaterials();
                applyFilters();
                populateParentPartNumberSelect();
            }
        }


        function updateQuantity(partNumber, newQuantity) {
            const material = materials.find(m => m.partNumber === partNumber);
            if (material) {
                const parsedQuantity = parseInt(newQuantity);
                if (!isNaN(parsedQuantity) && parsedQuantity >= 0) {
                    material.quantity = parsedQuantity;
                    localStorage.setItem('bomMaterials', JSON.stringify(materials));
                    applyFilters(); // Tabloyu yeniden render ederek değişikliği yansıt
                } else {
                    alert('Lütfen geçerli bir miktar girin.');
                    applyFilters(); // Hatalı girişi düzeltmek için tabloyu geri yükle
                }
            }
        }

        function updateWeight(partNumber, newWeight) {
            const material = materials.find(m => m.partNumber === partNumber);
            if (material) {
                const parsedWeight = parseFloat(newWeight);
                if (!isNaN(parsedWeight) && parsedWeight >= 0) {
                    material.weight = parsedWeight;
                    localStorage.setItem('bomMaterials', JSON.stringify(materials));
                    applyFilters();
                } else {
                    alert('Lütfen geçerli bir ağırlık girin.');
                    applyFilters();
                }
            }
        }

        function updateLevel(partNumber, newLevel) {
            const material = materials.find(m => m.partNumber === partNumber);
            if (material) {
                const parsedLevel = parseInt(newLevel);
                if (!isNaN(parsedLevel) && parsedLevel >= 1 && parsedLevel <= 4) {
                    material.level = parsedLevel;
                    localStorage.setItem('bomMaterials', JSON.stringify(materials));
                    applyFilters(); // Tabloyu yeniden render ederek değişikliği yansıt
                } else {
                    alert('Lütfen seviye için 1 ile 4 arasında geçerli bir sayı girin.');
                    // Kullanıcıya hatalı girişi düzeltmesi için mevcut değeri geri yükleyebiliriz
                    // applyFilters() çağrısı ile input değeri tekrar doğru hale gelecektir.
                }
            }
        }

        // Malzeme kaldırma fonksiyonu (partNumber ile)
        function removeMaterial(partNumber) {
            // Silinecek malzemeyi ve onun çocuklarını bul
            const itemsToRemove = [partNumber];
            const findChildren = (parentPn) => {
                materials.forEach(m => {
                    if (m.parentPartNumber === parentPn && !itemsToRemove.includes(m.partNumber)) {
                        itemsToRemove.push(m.partNumber);
                        findChildren(m.partNumber); // Rekürsif olarak çocukların çocuklarını bul
                    }
                });
            };
            findChildren(partNumber);

            materials = materials.filter(material => !itemsToRemove.includes(material.partNumber));
            localStorage.setItem('bomMaterials', JSON.stringify(materials));
            applyFilters();
            populateParentPartNumberSelect();
        }

        // Ebeveyn Parça Numarasını güncelle
        function updateParentPartNumber(childPartNumber, newParentPartNumber) {
            const childMaterial = materials.find(m => m.partNumber === childPartNumber);
            if (childMaterial) {
                // Döngüsel referans kontrolü
                let currentParentChecker = newParentPartNumber === "" ? null : newParentPartNumber;
                while (currentParentChecker) {
                    if (currentParentChecker === childPartNumber) {
                        alert("Döngüsel referans hatası: Seçilen ebeveyn, bu malzemenin mevcut alt öğesidir veya alt öğesinin alt öğesidir. Lütfen geçerli bir ebeveyn seçin.");
                        applyFilters(); // Hatalı seçimi geri almak için tabloyu yeniden render et
                        return;
                    }
                    const parentObj = materials.find(m => m.partNumber === currentParentChecker);
                    currentParentChecker = parentObj ? parentObj.parentPartNumber : null;
                }

                childMaterial.parentPartNumber = newParentPartNumber === "" ? null : newParentPartNumber;

                // **YENİ EKLENEN KOD: Seviyeyi otomatik ayarla ve alt öğeleri güncelle**
                let newLevel;
                if (childMaterial.parentPartNumber === null) {
                    newLevel = 1;
                } else {
                    const parentMaterial = materials.find(m => m.partNumber === childMaterial.parentPartNumber);
                    newLevel = parentMaterial ? parentMaterial.level + 1 : 1;
                }
                childMaterial.level = newLevel;

                // Alt öğelerin seviyelerini recursive olarak güncelle
                const updateChildLevels = (parentPartNum, level) => {
                    materials.forEach(mat => {
                        if (mat.parentPartNumber === parentPartNum) {
                            mat.level = level + 1;
                            updateChildLevels(mat.partNumber, level + 1);
                        }
                    });
                };
                updateChildLevels(childPartNumber, newLevel);
                // **YENİ EKLENEN KOD BİTTİ**

                // Ana ürün durumunu da güncelleyelim
                childMaterial.isMainProduct = childMaterial.parentPartNumber === null;

                localStorage.setItem('bomMaterials', JSON.stringify(materials));
                applyFilters();
                populateParentPartNumberSelect();
            }
        }


        function searchMaterials() {
            applyFilters(); // Arama yapıldığında filtreleri yeniden uygula
        }

        function applyFilters() {
            let filtered = [...materials];
            const searchText = document.getElementById('searchInput').value.toLowerCase();

            // Arama kutusu filtresi
            if (searchText) {
                filtered = filtered.filter(material =>
                    (material.partNumber && material.partNumber.toLowerCase().includes(searchText)) ||
                    (material.description && material.description.toLowerCase().includes(searchText)) ||
                    (material.vendor && material.vendor.toLowerCase().includes(searchText)) ||
                    (material.rawMaterial && material.rawMaterial.toLowerCase().includes(searchText)) ||
                    (material.productionMethod && material.productionMethod.toLowerCase().includes(searchText)) ||
                    (material.assemblyType && material.assemblyType.toLowerCase().includes(searchText))
                );
            }

            // Production Location filtreleri
            if (showSupplier && showAsha) {
                // Her iki filtre de aktifse, hem "Supplier" hem de "ASHA" konumundaki parçaları göster
                filtered = filtered.filter(material => material.productionLocation === 'Supplier' || material.productionLocation === 'ASHA');
            } else if (showSupplier) {
                // Sadece "Supplier" filtresi aktifse, sadece "Supplier" konumundaki parçaları göster
                filtered = filtered.filter(material => material.productionLocation === 'Supplier');
            } else if (showAsha) {
                // Sadece "ASHA" filtresi aktifse, sadece "ASHA" konumundaki parçaları göster
                filtered = filtered.filter(material => material.productionLocation === 'ASHA');
            }
            // showSupplier ve showAsha'nın ikisi de false ise, üretim konumu filtresi uygulanmaz.

            // Raw Material filtresi
            if (showRawMaterial) {
                // Eğer Raw Material filtresi aktifse, diğer filtreleri devre dışı bırak
                document.getElementById('supplierCheckbox').classList.remove('checked');
                document.getElementById('ashaCheckbox').classList.remove('checked');
                showSupplier = false;
                showAsha = false;
                filtered = filtered.filter(material => material.rawMaterial && material.rawMaterial !== '');
            }

            displayMaterials(filtered);
            populateParentPartNumberSelect();
        }

        // 3D Model Görüntüleyici
        let scene, camera, renderer, controls;

        function openModelViewer(modelPath) {
            document.getElementById('modelViewer').style.display = 'block';
            const canvas = document.getElementById('modelCanvas');

            // Sahne, kamera, renderer oluştur
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xcccccc); // Gri arka plan
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);

            // Orbit Kontrolleri ekle
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.25;
            controls.screenSpacePanning = false;
            controls.maxPolarAngle = Math.PI / 2;

            // Işık ekle
            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(1, 1, 1).normalize();
            scene.add(directionalLight);

            // Modeli yükle
            const loader = new THREE.STLLoader(); // Model türüne göre yükleyiciyi değiştirin
            loader.load(modelPath, function (geometry) {
                const material = new THREE.MeshPhongMaterial({ color: 0x0055ff, specular: 0x111111, shininess: 200 });
                const mesh = new THREE.Mesh(geometry, material);
                scene.add(mesh);

                // Modeli ortala ve kamerayı ayarla
                geometry.computeBoundingBox();
                const boundingBox = geometry.boundingBox;
                const center = new THREE.Vector3();
                boundingBox.getCenter(center);
                mesh.position.sub(center); // Modeli sahnenin merkezine taşı

                const size = new THREE.Vector3();
                boundingBox.getSize(size);
                const maxDim = Math.max(size.x, size.y, size.z);
                const fov = camera.fov * (Math.PI / 180);
                let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
                cameraZ *= 1.5; // Biraz boşluk bırak
                camera.position.set(center.x, center.y, cameraZ);
                camera.lookAt(center);

                controls.target.copy(center);
                controls.update();

                animate();
            }, undefined, function (error) {
                console.error('3D modeli yüklenirken hata oluştu:', error);
                alert('3D modeli yüklenirken bir hata oluştu.');
                closeModelViewer();
            });
        }

        function animate() {
            if (!renderer) return; // Renderer yoksa animasyonu durdur
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        function closeModelViewer() {
            // Belleği temizle
            if (scene) {
                scene.traverse(object => {
                    if (object.geometry) object.geometry.dispose();
                    if (object.material) object.material.dispose();
                });
                scene = null;
            }
            controls = null;
            camera = null;
            document.getElementById('modelViewer').style.display = 'none';
        }

        window.addEventListener('resize', () => {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });

        // Filtre kutucuklarının durumunu değiştirir
        function toggleFilter(filterType) {
            const supplierCheckbox = document.getElementById('supplierCheckbox');
            const ashaCheckbox = document.getElementById('ashaCheckbox');
            const rawMaterialCheckbox = document.getElementById('rawMaterialCheckbox');

            if (filterType === 'RAW_MATERIAL') {
                showRawMaterial = !showRawMaterial;
                if (showRawMaterial) {
                    showSupplier = false;
                    showAsha = false;
                    supplierCheckbox.classList.remove('checked');
                    ashaCheckbox.classList.remove('checked');
                }
            } else {
                // Eğer MAKE veya BUY seçilirse Raw Material filtresini kapat
                if (showRawMaterial) {
                    showRawMaterial = false;
                    rawMaterialCheckbox.classList.remove('checked');
                }

                if (filterType === 'BUY') {
                    showSupplier = !showSupplier;
                    supplierCheckbox.classList.toggle('checked', showSupplier);
                } else if (filterType === 'MAKE') {
                    showAsha = !showAsha;
                    ashaCheckbox.classList.toggle('checked', showAsha);
                }
            }

            // Checkbox durumlarını güncelle
            rawMaterialCheckbox.classList.toggle('checked', showRawMaterial);

            applyFilters();
        }
    </script>
</body>
</html>
